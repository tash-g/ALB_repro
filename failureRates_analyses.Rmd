---
title: "Analyses for: *Parental coordination and environment interact to drive breeding success in albatrosses*"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

This document contains the analyses for the main paper, and can be used to produce all the results, tables, and figures from the manuscript and supplementary materials. Note that while these are the most up-to-date versions of the results, there may be minor deviations in the text (e.g. captions, wording of results) between this document and the main manuscript.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Decide whether to run full analyses or not - change to 'TRUE' to re-run
run_full_analysis <- FALSE

# Load functions, packages, & data -----

# Functions for GPS processing and plotting
source("ALB_FOR_functions.R")

# Define the packages
packages <- c("bayestestR","brms", "cowplot","dplyr", "extrafont","GGally", "ggplot2","ggpubr", "kableExtra", "magrittr", "performance", "tidybayes", "tidyverse")

## Load packages
invisible(lapply(packages, library, character.only = TRUE))

# Suppress dplyr summarise warning
options(dplyr.summarise.inform = FALSE)

# Make sure using dplyr select
select <- dplyr::select


# Set parameters -----

### Set species

species <- c("baBI", "baKer", "waBI", "waCro")

### Define ROPE bounds

rope_lower = -0.1
rope_upper = 0.1

### Set colour parameters

ker_col <-  "#156082" 
ker_col.high <- "#155470"
ker_col.low <- "#96d0eb"

bi_col <- "#E97132" 
bi_col.low <- "#f59b6c"
bi_col.high <- "#E97132" 

### Set labels

my_labels <- c(
  expression(italic("V")),
  expression(italic("D")),
  expression(italic("T")),
  expression(italic("F"))
)

# Set up variable labeller
variable_labels <- c(
  "debt.days:colony" =  expression("Fasting debt,"~italic("F")),
  "median_trip.days:colony" = expression("Pair-level median trip duration,"~italic("T")),
  "diff_trip.days:colony" = expression("Within-pair difference in trip duration,"~italic("D")),
  "diff_var.days:colony" = expression("Within-pair difference in trip variability,"~italic("V"))
)

```

```{r load_datasets}

# Load incubation data

load("Data_inputs/all_pair_behaviour_incub.RData")

bbal_incub.behaviour <- pair_behaviour.incub %>% filter(species == "BBA") 
waal_incub.behaviour <- pair_behaviour.incub %>% filter(species == "WAAL")

# Load brooding data

load("Data_inputs/all_pair_behaviour_brooding.RData")

bbal_brooding.behaviour <- pair_behaviour.brooding %>% filter(species == "BBA") 
waal_brooding.behaviour <- pair_behaviour.brooding %>% filter(species == "WAAL")


# Data with sex (just for sample sizes)
load("Data_inputs/all_pair_behaviour_incub_withSex.RData")
load("Data_inputs/all_pair_behaviour_brooding_withSex.RData")

```

### Sample sizes

```{r calculate_sample_sizes}

# Get unique pairs per species/colony
all_pairs <- rbind(pair_behaviour.incub %>% select(c(pairID, species, colony)), 
                   pair_behaviour.brooding %>% select(c(pairID, species, colony))) %>%
             mutate(speCol = paste0(species, "_", colony))

all_pairs.sample <- tapply(all_pairs$pairID, all_pairs$speCol, n_distinct)

## INCUBATION ## 

# Pairs
pairs_incub <- tapply(pair_behaviour.incub$pairID, pair_behaviour.incub$speCol, n_distinct)
pairs_incub.sex <- tapply(pair_behaviour.incub_withSex$pairID, pair_behaviour.incub_withSex$speCol, n_distinct)

# Observations
obs_incub <- table(pair_behaviour.incub$speCol)
obs_incub.sex <- table(pair_behaviour.incub_withSex$speCol)

# Years
years_incub <- tapply(pair_behaviour.incub$season, pair_behaviour.incub$speCol, unique)
years_incub.sex <- tapply(pair_behaviour.incub_withSex$season, pair_behaviour.incub_withSex$speCol, n_distinct)


## BROODING ## 

# Pairs
pairs_brooding <- tapply(pair_behaviour.brooding$pairID, pair_behaviour.brooding$speCol, n_distinct)
pairs_brooding.sex <- tapply(pair_behaviour.brooding_withSex$pairID, pair_behaviour.brooding_withSex$speCol, n_distinct)

# Observations
obs_brooding <- table(pair_behaviour.brooding$speCol)
obs_brooding.sex <- table(pair_behaviour.brooding_withSex$speCol)

# Years
years_brooding <- tapply(pair_behaviour.brooding$season, pair_behaviour.brooding$speCol, unique)
years_brooding.sex <- tapply(pair_behaviour.brooding_withSex$season, pair_behaviour.brooding_withSex$speCol, n_distinct)


# Collate data -----

table_s1 <- data.frame(
                      Species = c("BBAL", "BBAL", "BBAL", "BBAL", "WAAL", "WAAL", "WAAL", "WAAL"),
                      Colony = c("Bird Island", "Bird Island", "Kerguelen", "Kerguelen", "Bird Island", "Bird Island", "Crozet", "Crozet"),
                      Phase = c("Incubation", "Brooding", "Incubation", "Brooding", "Incubation", "Brooding", "Incubation", "Brooding"),
           Pairs = c( paste0(pairs_incub[1], " (", pairs_incub.sex[1], ")"),
                      paste0(pairs_incub[2], " (", pairs_incub.sex[2], ")"),
                      paste0(pairs_incub[3], " (", pairs_incub.sex[3], ")"),
                      paste0(pairs_incub[4], " (", pairs_incub.sex[4], ")"),
                      paste0(pairs_brooding[1], " (", pairs_brooding.sex[1], ")"),
                      paste0(pairs_brooding[2], " (", pairs_brooding.sex[2], ")"),
                      paste0(pairs_brooding[3], " (", pairs_brooding.sex[3], ")"),
                      paste0(pairs_brooding[4], " (", pairs_brooding.sex[4], ")") ),
           Observations = c( paste0(obs_incub[1], " (", obs_incub.sex[1], ")"),
                      paste0(obs_incub[2], " (", obs_incub.sex[2], ")"),
                      paste0(obs_incub[3], " (", obs_incub.sex[3], ")"),
                      paste0(obs_incub[4], " (", obs_incub.sex[4], ")"),
                      paste0(obs_brooding[1], " (", obs_brooding.sex[1], ")"),
                      paste0(obs_brooding[2], " (", obs_brooding.sex[2], ")"),
                      paste0(obs_brooding[3], " (", obs_brooding.sex[3], ")"),
                      paste0(obs_brooding[4], " (", obs_brooding.sex[4], ")") ),
           Seasons = c(paste(sort(unique(years_incub[[1]])), collapse = ", "),
                       paste(sort(unique(years_incub[[2]])), collapse = ", "),
                       paste(sort(unique(years_incub[[3]])), collapse = ", "),
                       paste(sort(unique(years_incub[[4]])), collapse = ", "),
                       paste(sort(unique(years_brooding[[1]])), collapse = ", "),
                       paste(sort(unique(years_brooding[[2]])), collapse = ", "),
                       paste(sort(unique(years_brooding[[3]])), collapse = ", "),
                       paste(sort(unique(years_brooding[[4]])), collapse = ", ")
                       )
           )

rm(pair_behaviour.incub_withSex)
rm(pair_behaviour.brooding_withSex)

```

Pairs of black-browed albatrosses were tracked from Bird Island, South Georgia (54° 00′ S, 38° 03′ W; `r as.numeric(all_pairs.sample[1])` pairs) and Cañon de Sourcils Noirs, Kerguelen Islands (49°41′ S, 70°14′ E; `r as.numeric(all_pairs.sample[2])` pairs), and of wandering albatrosses were tracked from Bird Island (`r as.numeric(all_pairs.sample[3])` pairs) and Possession Island, Crozet Islands (46°24′ S, 51°46′ E; `r as.numeric(all_pairs.sample[4])` pairs). Data were collected during the breeding seasons between austral summers 2002/03 and 2022/23.

```{r table_s1_sample_sizes}

table_s1 %>%
  kable("html", row.names = FALSE,
        caption = "Table S1.Sample sizes used in the study. ‘Observations’ denote the summarized breeding behaviours recorded for each pair throughout the breeding season, with each observation representing the collective behaviours of one pair. Parentheses contain the number of pairs/observations for pairs where sex was known. BBAL = black-browed albatross; WAAL = wandering albatross.") %>%
  row_spec(0, bold = TRUE) %>% 
  column_spec(6, width = "200px", extra_css = "white-space: normal;") %>%
  collapse_rows(columns = c(1, 2, 3)) %>%
  kable_classic() 

```

Breeding success is summarised as: failed at egg stage, failed at chick stage, unknown stage of failure, and success. Due to limited sample sizes, in the main analyses failure at egg stage and failure at chick stage are combind into 'failure' (breeding success = 0).

```{r TableS2_summarise_failure_rates}

all_outcomes <- rbind(pair_behaviour.incub %>% select(c(pairID, species, colony, breeding_outcome)), 
                   pair_behaviour.brooding %>% select(c(pairID, species, colony, breeding_outcome))) %>%
             mutate(speCol = paste0(species, "_", colony))


failure_summary <- all_outcomes %>%
  group_by(species, colony) %>%
  rename(Species = species, Colony = colony) %>%
  summarise(
    Observations = n(),
    "Egg failed" = round(sum(breeding_outcome == "FAILED_EGG")/Observations*100, 2),
    "Chick failed" = round(sum(breeding_outcome == "FAILED_CHICK")/Observations*100, 2),
    "Failure stage unknown" = round(sum(breeding_outcome == "FAILED")/Observations*100, 2),
    Successful = round(sum(breeding_outcome == "SUCCESSFUL")/Observations*100, 2)) %>%
  mutate(Species = ifelse(Species == "BBA", "BBAL", "WAAL"),
         Colony = case_when(
           Colony == "birdisland" ~ "Bird Island",
           Colony == "kerguelen" ~ "Kerguelen",
           Colony == "crozet" ~ "Crozet") )

failure_table <- as.data.frame(t(failure_summary))
failure_table <- rownames_to_column(failure_table, var = "param")
colnames(failure_table) <- NULL

failure_summary %>%
  kable("html", row.names = FALSE,
        caption = "Table S2. Summary of breeding success across each species and colony, expressed as a percentage of the total number of observations.") %>%
  collapse_rows(columns = 1) %>%
  row_spec(0, bold = TRUE) %>% 
  row_spec(3, extra_css = "border-top: 1px solid black;") %>%
  kable_classic() 


```

## Model structure

Here, I constructed Bayesian binomial regression models to look at how each of these behaviours effect breeding success, and how this differs between colonies. The model structure is explained below.

For both the black-browed albatrosses (BBA) and wandering albatrosses (WAAL), and across the two breeding stages (incubation and brooding), we modelled breeding success (denoted as $B$) as a Bernoulli-distributed response variable:

$B_i \sim \text{Bernoulli}(p_i)$

where $p_i$ represents the probability of breeding success. The logit of $p_i$ was modeled as:

$\text{logit}(p_i) = \beta_0 + \beta_1 F_i + \beta_2 T_i + \beta_3 D_i + \beta_4 D_i + \beta_5 C_i + C_i (\beta_6 F_i + \beta_7 T_i + \beta_8 D_i + \beta_9 D_i) + U_i^{\text{season}}$

where: - $F_i$ is the fasting debt, - $T_i$ is the pair-level median trip duration, - $D_i$ is the within-pair difference in trip duration, - $D_i$ is the within-pair difference in trip variability, - $C_i$ is the colony (Bird Island, Kerguelen, or Possession Island), and - $U_i^{\text{season}} \sim \mathcal{N}(0, \sigma_s^2)$ represents the random effect of season, accounting for inter-annual variation in breeding success.

We applied weakly informative normal priors to the fixed effects related to the behavioural metrics, based on prior literature:

-   $\beta_1 \sim \mathcal{N}(-0.5, 1)$
-   $\beta_2 \sim \mathcal{N}(-0.5, 0.5)$)
-   $\beta_3 \sim \mathcal{N}(-0.25, 0.5)$
-   $\beta_4 \sim \mathcal{N}(-0.12, 0.5)$

```{r build_models, eval = run_full_analysis}

## Specify priors

# BBA 
bbal.priors <- c(set_prior("normal(-0.5, 1)", class = "b", coef = "debt.days"),
                set_prior("normal(-0.25, 0.5)", class = "b", coef = "median_trip.days"),       
                set_prior("normal(-0.5, 0.5)", class = "b", coef = "diff_trip.days"),
                set_prior("normal(-0.12, 0.5)", class = "b", coef = "diff_var.days"))

# WAAL
waal.priors <- c( set_prior("normal(-0.5, 1)", class = "b", coef = "debt.days"),
                  set_prior("normal(-0.25, 0.5)", class = "b", coef = "median_trip.days"),       
                  set_prior("normal(-0.5, 0.5)", class = "b", coef = "diff_trip.days"),
                  set_prior("normal(-0.12, 0.5)", class = "b", coef = "diff_var.days"))


## Specify formula

bf <- brms::bf(breeding_outcome.bin ~
                          debt.days * colony +
                          median_trip.days * colony +
                          diff_trip.days * colony +
                          diff_var.days * colony +
                          (1|season), 
                        family = "bernoulli")

# INCUBATION #####

## BBA 
bbal_incub.brms <- brm(bf,
              data = bbal_incub.behaviour, 
              cores = 4, chains = 4, 
              iter = 20000, warmup = 10000, thin = 10,
              control = list(adapt_delta = 0.9999, max_treedepth = 14),
              prior = bbal.priors)

summary(bbal_incub.brms)
#pp_check(bbal_incub.brms, ndraw = 50)
save(bbal_incub.brms, file = "Data_outputs/bbal_incub_brms_model.RData")


## WAAL 
waal_incub.brms <- brm(bf,
                      data = waal_incub.behaviour, 
                      cores = 4, chains = 4, 
                      iter = 20000, warmup = 10000, thin = 10,
                      control = list(adapt_delta = 0.9999, max_treedepth = 14),
                      prior = waal.priors)

summary(waal_incub.brms)
#pp_check(waal_incub.brms, ndraw = 50)
save(waal_incub.brms, file = "Data_outputs/waal_incub_brms_model.RData")

# BROODING #####

## BBA 
bbal_brooding.brms <- brm(bf,
                         data = bbal_brooding.behaviour, 
                         cores = 4, chains = 4, 
                         iter = 20000, warmup = 10000, thin = 10,
                         control = list(adapt_delta = 0.9999, max_treedepth = 14))


summary(bbal_brooding.brms)
#pp_check(bbal_brooding.brms)
save(bbal_brooding.brms, file = "Data_outputs/bbal_brooding_brms_model.RData")


## WAAL
waal_brooding.brms <- brm(bf,
                       data = waal_brooding.behaviour, 
                       cores = 4, chains = 4, 
                       iter = 20000, warmup = 10000, thin = 10,
                       control = list(adapt_delta = 0.9999, max_treedepth = 14),
                       prior = waal.priors)

summary(waal_brooding.brms)
#pp_check(waal_brooding.brms)
save(waal_brooding.brms, file = "Data_outputs/waal_brooding_brms_model.RData")

```

#### Check for multicolinearity

```{r TableS3_check_vif}

load("Data_outputs/bbal_incub_brms_model.RData")
load("Data_outputs/waal_incub_brms_model.RData")
load("Data_outputs/bbal_brooding_brms_model.RData")
load("Data_outputs/waal_brooding_brms_model.RData")

vif_incub.bbal <- data.frame(check_collinearity(bbal_incub.brms)) %>%
  mutate(Species = "BBAL", Phase = "Incubation") %>%
  relocate(c(Species, Phase), .before = Term)

vif_incub.waal <- data.frame(check_collinearity(waal_incub.brms)) %>%
  mutate(Species = "WAAL", Phase = "Incubation") %>%
  relocate(c(Species, Phase), .before = Term)

vif_brooding.bbal <- data.frame(check_collinearity(bbal_brooding.brms)) %>%
  mutate(Species = "BBAL", Phase = "Brooding") %>%
  relocate(c(Species, Phase), .before = Term)

vif_brooding.waal <- data.frame(check_collinearity(waal_brooding.brms)) %>%
  mutate(Species = "WAAL", Phase = "Brooding") %>%
  relocate(c(Species, Phase), .before = Term)

TableS3 <- rbind(vif_incub.bbal, vif_brooding.bbal, vif_incub.waal, vif_brooding.waal) 
TableS3 %<>% mutate(VIF = round(VIF, 2), 
                    VIF_CI_low = round(VIF_CI_low, 2), 
                    VIF_CI_high = round(VIF_CI_high, 2),
                    VIF = paste0(VIF, " [", VIF_CI_low, ", ", VIF_CI_high, "]"),
                    Term = case_when(
                      Term == "debt.days" ~ "Fasting debt",
                      Term == "colony" ~ "Colony",
                      Term == "median_trip.days" ~ "Pair-level median trip duration",
                      Term == "diff_trip.days" ~ "within-pair difference in trip duration",
                      Term == "diff_var.days" ~ "within-pair difference in trip variability")) %>% 
  select(-c(SE_factor,Tolerance, Tolerance_CI_low, Tolerance_CI_high, VIF_CI_low, VIF_CI_high))

TableS3 %>%
  kable("html", row.names = FALSE,
        caption = "Table S3. Variance Inflation Factors (VIF) for fixed effects in the breeding success models used in the analyses. Dalues < 5 indicate low multicollinearity. VIF estimates include 95% confidence intervals. BBAL = black-browed albatross; WAAL = wandering albatross.") %>%
  row_spec(6, extra_css = "border-top: 1px dashed black;") %>%
  row_spec(11, extra_css = "border-top: 1px solid black;") %>%
  row_spec(16, extra_css = "border-top: 1px dashed black;") %>%
  collapse_rows(columns = c(1,2)) %>%
  row_spec(0, bold = TRUE) %>% 
  kable_classic() 

#readr::write_excel_csv(TableS3, "Data_outputs/TableS3_vif.csv")

```

#### Calculate and plot posterior estimates

```{r calculate_posterior_estimates}

# Load models
load("Data_outputs/bbal_incub_brms_model.RData")
load("Data_outputs/waal_incub_brms_model.RData")
load("Data_outputs/bbal_brooding_brms_model.RData")
load("Data_outputs/waal_brooding_brms_model.RData")

# BBAL ------
## INCUBATION -----

bbal_incub.posterior_samples <- as_draws_df(bbal_incub.brms)

# Extract posterior samples by colony
predictors <- colnames(bbal_incub.posterior_samples)[2:6]
predictors <- predictors[-2]
interaction_terms <- colnames(bbal_incub.posterior_samples)[7:10]
bbal_incub.posteriors <- data.frame()

for (i in 1:length(predictors)) {
  
  # Extract the main effect (Bird Island)
  bird_est <- bbal_incub.posterior_samples[[predictors[i]]]
  
  # Extract the interaction effect and add it to the main effect for Kerguelen
  kerg_est <- bird_est + bbal_incub.posterior_samples[[interaction_terms[i]]]
  
  temp_df <- data.frame(
    variable = predictors[i],
    value = c(bird_est, kerg_est),
    colony = rep(c("Bird Island", "Kerguelen"), each = length(bird_est))
  )
  
  bbal_incub.posteriors <- rbind(bbal_incub.posteriors, temp_df)

}

## Relevel factors
bbal_incub.posteriors %<>%
  mutate(variable = fct_rev(fct_relevel(variable, 
                                        c("b_debt.days", 
                                          "b_median_trip.days", 
                                          "b_diff_trip.days", 
                                          "b_diff_var.days"))))


### Build the posteriors plot -----

bbal_incub.posteriors_plot <- 
  ggplot() +
  stat_halfeye(data = subset(bbal_incub.posteriors, colony == "Bird Island"), 
               side = "bottom", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "bi_low", 
                                 ifelse(after_stat(x) > rope_upper, "bi_high", "grey80"))),
               height = 0.7) +
  stat_halfeye(data = subset(bbal_incub.posteriors, colony == "Kerguelen"), 
               side = "top", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "ker_low", 
                                 ifelse(after_stat(x) > rope_upper, "ker_high", "grey80"))),
               height = 0.7) +
    scale_fill_manual(values = c(
    "bi_low" = bi_col.low, "bi_high" = bi_col.high,
    "ker_low" = ker_col.low, "ker_high" = ker_col.high ) ) +
  scale_y_discrete(labels = my_labels) +
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = 1, col = "grey20") +
   geom_rect(aes(xmin = rope_lower, xmax = rope_upper, ymin = -Inf, ymax = Inf),
              fill = "lightcyan4", alpha = 0.25) +
  labs(y = "", 
       x = expression(logit(italic(p)))) +
  theme_bw() +
  theme(text = element_text(size = 16, family = "Calibri"),
        legend.position = "none")


### Build the fixed effects summary table ----

bbal_incub.fixef <- round(summary(bbal_incub.brms)$fixed, digits = 2)
bbal_incub.fixef[,c(6,7)] <- round(bbal_incub.fixef[,c(6,7)], digits = 0)

# Get odds ratios
exp_coef <- round(exp(bbal_incub.fixef[,c(1, 3, 4)]), digits = 2)
colnames(exp_coef) <- c("Estimate_exp", "LCI_exp", "UCI_exp")
rownames(exp_coef) <- NULL

# Get proportion in ROPE
rope_results <- lapply(bbal_incub.posterior_samples[, 1:10], function(x) {
  rope(x, range = c(rope_lower, rope_upper), ci = 0.95)})
prop_rope <- data.frame(sapply(rope_results, function(res) res$ROPE_Percentage))[,1]

## Bind everything together
bbal_incub.fixef <- cbind(bbal_incub.fixef, exp_coef)
bbal_incub.fixef$prop_rope <- round(prop_rope, digits = 2)

## Process each variable
ker_debt <- process_interaction_estimates("b_debt.days", bbal_incub.fixef, bbal_incub.posterior_samples, "b_debt.days:colonykerguelen")
ker_median_trip <- process_interaction_estimates("b_median_trip.days", bbal_incub.fixef, bbal_incub.posterior_samples, "b_colonykerguelen:median_trip.days")
ker_diff_trip <- process_interaction_estimates("b_diff_trip.days", bbal_incub.fixef, bbal_incub.posterior_samples, "b_colonykerguelen:diff_trip.days")
ker_diff_var <- process_interaction_estimates("b_diff_var.days", bbal_incub.fixef, bbal_incub.posterior_samples, "b_colonykerguelen:diff_var.days")

# Combine the results with the original fixef data
ker_fixef <- rbind(ker_debt, ker_median_trip, ker_diff_trip, ker_diff_var)
colnames(ker_fixef) <- colnames(bbal_incub.fixef)
ker_fixef <- round(ker_fixef, 2)

bbal_incub.fixef <- rbind(bbal_incub.fixef, ker_fixef)



## BROODING -----

bbal_brooding.posterior_samples <- as_draws_df(bbal_brooding.brms)

# Extract posterior samples by colony
predictors <- colnames(bbal_brooding.posterior_samples)[2:6]
predictors <- predictors[-2]
interaction_terms <- colnames(bbal_brooding.posterior_samples)[7:10]
bbal_brooding.posteriors <- data.frame()

for (i in 1:length(predictors)) {

  # Extract the main effect (Bird Island)
  bird_est <- bbal_brooding.posterior_samples[[predictors[i]]]

  # Extract the interaction effect and add it to the main effect for Kerguelen
  kerg_est <- bird_est + bbal_brooding.posterior_samples[[interaction_terms[i]]]

  temp_df <- data.frame(
    variable = predictors[i],
    value = c(bird_est, kerg_est),
    colony = rep(c("Bird Island", "Kerguelen"), each = length(bird_est))
  )

  bbal_brooding.posteriors <- rbind(bbal_brooding.posteriors, temp_df)

}

## Relevel factors
bbal_brooding.posteriors %<>%
  mutate(variable = fct_rev(fct_relevel(variable,
                                        c("b_debt.days",
                                          "b_median_trip.days",
                                          "b_diff_trip.days",
                                          "b_diff_var.days"))))

### Build the posteriors plot -----

bbal_brooding.posteriors_plot <- 
  ggplot() +
  stat_halfeye(data = subset(bbal_brooding.posteriors, colony == "Bird Island"), 
               side = "bottom", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "bi_low", 
                                 ifelse(after_stat(x) > rope_upper, "bi_high", "grey80"))),
               height = 0.7) +
  stat_halfeye(data = subset(bbal_brooding.posteriors, colony == "Kerguelen"), 
               side = "top", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "ker_low", 
                                 ifelse(after_stat(x) > rope_upper, "ker_high", "grey80"))),
               height = 0.7) +
  scale_fill_manual(values = c(
    "bi_low" = bi_col.low, "bi_high" = bi_col.high,
    "ker_low" = ker_col.low, "ker_high" = ker_col.high ) ) +
  scale_y_discrete(labels = my_labels) +
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = 1, col = "grey20") +
  geom_rect(aes(xmin = rope_lower, xmax = rope_upper, ymin = -Inf, ymax = Inf),
            fill = "lightcyan4", alpha = 0.25) +
  labs(y = "", 
       x = expression(logit(italic(p)))) +
  theme_bw() +
  theme(text = element_text(size = 16, family = "Calibri"),
        legend.position = "none")

### Build the fixed effects summary table ----

bbal_brooding.fixef <- round(summary(bbal_brooding.brms)$fixed, digits = 2)
bbal_brooding.fixef[,c(6,7)] <- round(bbal_brooding.fixef[,c(6,7)], digits = 0)

# Get odds ratios
exp_coef <- round(exp(bbal_brooding.fixef[,c(1, 3, 4)]), digits = 2)
colnames(exp_coef) <- c("Estimate_exp", "LCI_exp", "UCI_exp")
rownames(exp_coef) <- NULL

# Get proportion in ROPE
rope_results <- lapply(bbal_brooding.posterior_samples[, 1:10], function(x) {
  rope(x, range = c(rope_lower, rope_upper), ci = 0.95)})
prop_rope <- data.frame(sapply(rope_results, function(res) res$ROPE_Percentage))[,1]

## Bind everything together
bbal_brooding.fixef <- cbind(bbal_brooding.fixef, exp_coef)
bbal_brooding.fixef$prop_rope <- round(prop_rope, digits = 2)

## Process each variable
ker_debt <- process_interaction_estimates("b_debt.days", bbal_brooding.fixef, bbal_brooding.posterior_samples, "b_debt.days:colonykerguelen")
ker_median_trip <- process_interaction_estimates("b_median_trip.days", bbal_brooding.fixef, bbal_brooding.posterior_samples, "b_colonykerguelen:median_trip.days")
ker_diff_trip <- process_interaction_estimates("b_diff_trip.days", bbal_brooding.fixef, bbal_brooding.posterior_samples, "b_colonykerguelen:diff_trip.days")
ker_diff_var <- process_interaction_estimates("b_diff_var.days", bbal_brooding.fixef, bbal_brooding.posterior_samples, "b_colonykerguelen:diff_var.days")

# Combine the results with the original fixef data
ker_fixef <- rbind(ker_debt, ker_median_trip, ker_diff_trip, ker_diff_var)
colnames(ker_fixef) <- colnames(bbal_brooding.fixef)
ker_fixef <- round(ker_fixef, 2)

bbal_brooding.fixef <- rbind(bbal_brooding.fixef, ker_fixef)


# WAAL  --------
## INCUBATION --------

waal_incub.posterior_samples <- as_draws_df(waal_incub.brms)

# Extract posterior samples by colony
predictors <- colnames(waal_incub.posterior_samples)[2:6]
predictors <- predictors[-2]
interaction_terms <- colnames(waal_incub.posterior_samples)[7:10]
waal_incub.posteriors <- data.frame()

for (i in 1:length(predictors)) {
  
  # Extract the main effect (Bird Island)
  bird_est <- waal_incub.posterior_samples[[predictors[i]]]
  
  # Extract the interaction effect and add it to the main effect for Kerguelen
  cro_est <- bird_est + waal_incub.posterior_samples[[interaction_terms[i]]]
  
  temp_df <- data.frame(
    variable = predictors[i],
    value = c(bird_est, cro_est),
    colony = rep(c("Bird Island", "Crozet"), each = length(bird_est))
  )
  
  waal_incub.posteriors <- rbind(waal_incub.posteriors, temp_df)
  
}

## Relevel factors
waal_incub.posteriors %<>%
  mutate(variable = fct_rev(fct_relevel(variable, 
                                        c("b_debt.days", 
                                          "b_median_trip.days", 
                                          "b_diff_trip.days", 
                                          "b_diff_var.days"))))

### Build posteriors plot --------

waal_incub.posteriors_plot <- 
  ggplot() +
  stat_halfeye(data = subset(waal_incub.posteriors, colony == "Bird Island"), 
               side = "bottom", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "bi_low", 
                                 ifelse(after_stat(x) > rope_upper, "bi_high", "grey80"))),
               height = 0.7) +
  stat_halfeye(data = subset(waal_incub.posteriors, colony == "Crozet"), 
               side = "top", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "cro_low", 
                                 ifelse(after_stat(x) > rope_upper, "cro_high", "grey80"))),
               height = 0.7) +
  scale_fill_manual(values = c(
    "bi_low" = bi_col.low, "bi_high" = bi_col.high,
    "cro_low" = ker_col.low, "cro_high" = ker_col.high ) ) +
  scale_y_discrete(labels = my_labels) +
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = 1, col = "grey20") +
  geom_rect(aes(xmin = rope_lower, xmax = rope_upper, ymin = -Inf, ymax = Inf),
            fill = "lightcyan4", alpha = 0.25) +
  labs(y = "", 
       x = expression(logit(italic(p)))) +
  theme_bw() +
  theme(text = element_text(size = 16, family = "Calibri"),
        legend.position = "none")


### Build the fixed effects summary table ----

waal_incub.fixef <- round(summary(waal_incub.brms)$fixed, digits = 2)
waal_incub.fixef[,c(6,7)] <- round(waal_incub.fixef[,c(6,7)], digits = 0)

# Get odds ratios
exp_coef <- round(exp(waal_incub.fixef[,c(1, 3, 4)]), digits = 2)
colnames(exp_coef) <- c("Estimate_exp", "LCI_exp", "UCI_exp")
rownames(exp_coef) <- NULL

# Get proportion in ROPE
rope_results <- lapply(waal_incub.posterior_samples[, 1:10], function(x) {
  rope(x, range = c(rope_lower, rope_upper), ci = 0.95)})
prop_rope <- data.frame(sapply(rope_results, function(res) res$ROPE_Percentage))[,1]

## Bind everything together
waal_incub.fixef <- cbind(waal_incub.fixef, exp_coef)
waal_incub.fixef$prop_rope <- round(prop_rope, digits = 2)

### Process each variable
cro_debt <- process_interaction_estimates("b_debt.days", waal_incub.fixef, waal_incub.posterior_samples, "b_debt.days:colonycrozet")
cro_median_trip <- process_interaction_estimates("b_median_trip.days", waal_incub.fixef, waal_incub.posterior_samples, "b_colonycrozet:median_trip.days")
cro_diff_trip <- process_interaction_estimates("b_diff_trip.days", waal_incub.fixef, waal_incub.posterior_samples, "b_colonycrozet:diff_trip.days")
cro_diff_var <- process_interaction_estimates("b_diff_var.days", waal_incub.fixef, waal_incub.posterior_samples, "b_colonycrozet:diff_var.days")

# Combine the results with the original fixef data
cro_fixef <- rbind(cro_debt, cro_median_trip, cro_diff_trip, cro_diff_var)
colnames(cro_fixef) <- colnames(waal_incub.fixef)
cro_fixef <- round(cro_fixef, 2)

waal_incub.fixef <- rbind(waal_incub.fixef, cro_fixef)



## BROODING --------

waal_brooding.posterior_samples <- as_draws_df(waal_brooding.brms)

# Extract posterior samples by colony
predictors <- colnames(waal_brooding.posterior_samples)[2:6]
predictors <- predictors[-2]
interaction_terms <- colnames(waal_brooding.posterior_samples)[7:10]
waal_brooding.posteriors <- data.frame()

for (i in 1:length(predictors)) {
  
  # Extract the main effect (Bird Island)
  bird_est <- waal_brooding.posterior_samples[[predictors[i]]]
  
  # Extract the interaction effect and add it to the main effect for Kerguelen
  cro_est <- bird_est + waal_brooding.posterior_samples[[interaction_terms[i]]]
  
  temp_df <- data.frame(
    variable = predictors[i],
    value = c(bird_est, cro_est),
    colony = rep(c("Bird Island", "Crozet"), each = length(bird_est))
  )
  
  waal_brooding.posteriors <- rbind(waal_brooding.posteriors, temp_df)
  
}

## Relevel factors
waal_brooding.posteriors %<>%
  mutate(variable = fct_rev(fct_relevel(variable, 
                                        c("b_debt.days", 
                                          "b_median_trip.days", 
                                          "b_diff_trip.days", 
                                          "b_diff_var.days"))))

### Build posteriors plot --------

waal_brooding.posteriors_plot <- 
  ggplot() +
  stat_halfeye(data = subset(waal_brooding.posteriors, colony == "Bird Island"), 
               side = "bottom", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "bi_low", 
                                 ifelse(after_stat(x) > rope_upper, "bi_high", "grey80"))),
               height = 0.7) +
  stat_halfeye(data = subset(waal_brooding.posteriors, colony == "Crozet"), 
               side = "top", 
               aes(x = value, y = variable,
                   fill = ifelse(after_stat(x) < rope_lower, "cro_low", 
                                 ifelse(after_stat(x) > rope_upper, "cro_high", "grey80"))),
               height = 0.7) +
  scale_fill_manual(values = c(
    "bi_low" = bi_col.low, "bi_high" = bi_col.high,
    "cro_low" = ker_col.low, "cro_high" = ker_col.high ) ) +
  scale_y_discrete(labels = my_labels) +
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = 1, col = "grey20") +
  geom_rect(aes(xmin = rope_lower, xmax = rope_upper, ymin = -Inf, ymax = Inf),
            fill = "lightcyan4", alpha = 0.25) +
  labs(y = "", 
       x = expression(logit(italic(p)))) +
  theme_bw() +
  theme(text = element_text(size = 16, family = "Calibri"),
        legend.position = "none")


### Build the fixed effects summary table ----

waal_brooding.fixef <- round(summary(waal_brooding.brms)$fixed, digits = 2)
waal_brooding.fixef[,c(6,7)] <- round(waal_brooding.fixef[,c(6,7)], digits = 0)

# Get odds ratios
exp_coef <- round(exp(waal_brooding.fixef[,c(1, 3, 4)]), digits = 2)
colnames(exp_coef) <- c("Estimate_exp", "LCI_exp", "UCI_exp")
rownames(exp_coef) <- NULL

# Get proportion in ROPE
rope_results <- lapply(waal_brooding.posterior_samples[, 1:10], function(x) {
  rope(x, range = c(rope_lower, rope_upper), ci = 0.95)})
prop_rope <- data.frame(sapply(rope_results, function(res) res$ROPE_Percentage))[,1]

## Bind everything together
waal_brooding.fixef <- cbind(waal_brooding.fixef, exp_coef)
waal_brooding.fixef$prop_rope <- round(prop_rope, digits = 2)

### Process each variable
cro_debt <- process_interaction_estimates("b_debt.days", waal_brooding.fixef, waal_brooding.posterior_samples, "b_debt.days:colonycrozet")
cro_median_trip <- process_interaction_estimates("b_median_trip.days", waal_brooding.fixef, waal_brooding.posterior_samples, "b_colonycrozet:median_trip.days")
cro_diff_trip <- process_interaction_estimates("b_diff_trip.days", waal_brooding.fixef, waal_brooding.posterior_samples, "b_colonycrozet:diff_trip.days")
cro_diff_var <- process_interaction_estimates("b_diff_var.days", waal_brooding.fixef, waal_brooding.posterior_samples, "b_colonycrozet:diff_var.days")

# Combine the results with the original fixef data
cro_fixef <- rbind(cro_debt, cro_median_trip, cro_diff_trip, cro_diff_var)
colnames(cro_fixef) <- colnames(waal_brooding.fixef)
cro_fixef <- round(cro_fixef, 2)

waal_brooding.fixef <- rbind(waal_brooding.fixef, cro_fixef)


```

```{r Figure1_posterior_estimates, fig.width = 10, fig.height = 10, fig.cap = "**Figure 1**. Posterior distributions (coloured ridges) and 95% credible intervals (black dot and horizontal lines) from Bayesian models examining the effects of pair-level foraging behaviours (F = fasting debt; T = pair-level median trip duration; D = within-pair difference in trip duration; V = within-pair difference in trip variability) on breeding success (p) during incubation (top panels) and brooding (bottom panels). Ridges are coloured by colony (blue for Kerguelen and Crozet, orange for Bird Island), with no additional meaning. The grey vertical bar in each panel bar indicates the Region of Practical Equivalence (ROPE); effects within this region are considered negligible. The greater the proportion of the ridge extending beyond the ROPE, the stronger the evidence for a true effect. Distributions on the right of the ROPE indicate a positive effect on breeding success, and on the left indicate a negative effect."}

# Add albatross silhouettes
bbal_incub.posteriors_plot2 <- ggdraw() +
  draw_plot(bbal_incub.posteriors_plot + labs(y = "Incubation") +
              annotate("text", x = 0.9, y = 4.5, label = "Increases success") +
              annotate("text", x = -0.6, y = 4.5, label = "Decreases success") +
                theme(axis.title.y = element_text(margin = margin(r = 20)),
                    axis.title.x = element_blank(),
                    text = element_text(size = 16, family = "Calibri"))) +
  draw_image(file.path("Figures/bbal_standing_silhouette.png"),
             scale = 0.25, x = 0.35, y = -0.28) 
  

waal_incub.posteriors_plot2 <- ggdraw() +
  draw_plot(waal_incub.posteriors_plot +
              annotate("text", x = 0.5, y = 4.5, label = "Increases success") +
              annotate("text", x = -0.4, y = 4.5, label = "Decreases success") +
              theme(axis.title.x = element_blank(),
                    axis.text.y = element_blank(),
                    text = element_text(size = 16, family = "Calibri"))) +
  draw_image(file.path("Figures/waal_standing_silhouette.png"),
             scale = 0.25, x = 0.38, y = -0.28)


#png(file = "Figures/FIGURE1.png", width = 10, height = 10, units = "in", res = 100)
ggarrange(bbal_incub.posteriors_plot2,
          waal_incub.posteriors_plot2,
          bbal_brooding.posteriors_plot + 
            labs(y = "Brooding") + 
            theme(axis.title.y = element_text(margin = margin(r = 20)),
                  plot.title = element_blank()),
          waal_brooding.posteriors_plot + 
            theme(plot.title = element_blank(),
                  axis.text.y = element_blank()),
          ncol = 2,
          nrow = 2,
          widths = c(1, 0.95))
#dev.off()

```

```{r Table1_bbal_coefficients}

# Main effects
bbal_incub.fixef_MS <- bbal_incub.fixef %>%
  mutate(est_error = paste0(Estimate, " \u00B1 ", Est.Error),
         cis = paste0('[', `l-95% CI`, ", ", `u-95% CI`, ']')) %>%
  select(est_error, cis, prop_rope) %>%
  rename('Estimate \u00B1 Est.Error' = est_error, '95% CIs' = cis, 'Inside ROPE' = prop_rope)

bbal_brooding.fixef_MS <- bbal_brooding.fixef %>%
  mutate(est_error = paste0(Estimate, " \u00B1 ", Est.Error),
         cis = paste0('[', `l-95% CI`, ", ", `u-95% CI`, ']')) %>%
  select(est_error, cis, prop_rope) %>%
  rename('Estimate \u00B1 Est.Error' = est_error, '95% CIs' = cis, 'Inside ROPE' = prop_rope)

table1 <- cbind(bbal_incub.fixef_MS, bbal_brooding.fixef_MS)

## Reorder and rename rows
new_order <- c("Intercept",
               "colonykerguelen", 
               "debt.days", 
               "median_trip.days", 
               "diff_trip.days", 
               "diff_var.days", 
               "debt.days:colonykerguelen", 
               "colonykerguelen:median_trip.days", 
               "colonykerguelen:diff_trip.days", 
               "colonykerguelen:diff_var.days", 
               "col.b_debt.days", 
               "col.b_median_trip.days", 
               "col.b_diff_trip.days", 
               "col.b_diff_var.days")

table1 <- table1[new_order, ]

# Rename rownames
new_names <- c(
  "Intercept",
  "Colony",
  "Fasting debt",
  "Pair-level median trip duration",
  "within-pair difference in trip duration",
  "within-pair difference in trip variability",
  "Fasting debt : Colony",
  "Pair-level median trip duration : Colony",
  "within-pair difference in trip duration : Colony",
  "within-pair difference in trip variability : Colony",
  "Fasting debt (Kerguelen)",
  "Pair-level median trip duration (Kerguelen)",
  "within-pair difference in trip duration (Kerguelen)",
  "within-pair difference in trip variability (Kerguelen)"
)

rownames(table1) <- new_names

## Get seasonal effects
bbal_incub.season.row <- summary(bbal_incub.brms)$random$season %>%
  as.data.frame() %>%
  mutate(`Estimate ± Est.Error` = paste0(round(Estimate, 2), " \u00B1 ", round(Est.Error, 2)),
         `95% CIs` = paste0("[", round(`l-95% CI`, 2), ", ", round(`u-95% CI`, 2), "]"),
          `Inside ROPE` = "") %>%
  select(`Estimate ± Est.Error`, `95% CIs`, `Inside ROPE`)

bbal_brooding.season.row <- summary(bbal_brooding.brms)$random$season %>%
  as.data.frame() %>%
  mutate(`Estimate ± Est.Error` = paste0(round(Estimate, 2), " \u00B1 ", round(Est.Error, 2)),
         `95% CIs` = paste0("[", round(`l-95% CI`, 2), ", ", round(`u-95% CI`, 2), "]"),
          `Inside ROPE` = "") %>%
  select(`Estimate ± Est.Error`, `95% CIs`, `Inside ROPE`)

bbal_season <- cbind(bbal_incub.season.row, bbal_brooding.season.row)
rownames(bbal_season) <- "(1|season)"
colnames(bbal_season) <- colnames(table1)
table1 <- rbind(table1, bbal_season)


table1 %>%
  kable("html", row.names = TRUE,
        caption = "Table 1. Parameter estimates from Bayesian binomial regression models examining the influence of behavioural parameters on breeding success in black-browed albatrosses during incubation and brooding periods. Estimates are reported as log odds ‘Inside ROPE’ gives the proportion of posterior samples falling within the Region of Practical Equivalence (ROPE), a range at which effects are considered minimal. Estimates where >95% of posterior samples fell outside the ROPE are highlighted in bold. ‘Bird Island’ is the reference value for the categorical predictor ‘colony’; estimates for Kerguelen have been calculated by adding the interaction term to the main effect.") %>%
  row_spec(0, bold = TRUE) %>% 
  kable_classic() 

#readr::write_excel_csv(table1, "Data_outputs/table1_bbal_coefficients.csv")

```

```{r Table2_waal_coefficients}

# Main effects
waal_incub.fixef_MS <- waal_incub.fixef %>%
  mutate(est_error = paste0(Estimate, " \u00B1 ", Est.Error),
         cis = paste0('[', `l-95% CI`, ", ", `u-95% CI`, ']')) %>%
  select(est_error, cis, prop_rope) %>%
  rename('Estimate \u00B1 Est.Error' = est_error, '95% CIs' = cis, 'Inside ROPE' = prop_rope)

waal_brooding.fixef_MS <- waal_brooding.fixef %>%
  mutate(est_error = paste0(Estimate, " \u00B1 ", Est.Error),
         cis = paste0('[', `l-95% CI`, ", ", `u-95% CI`, ']')) %>%
  select(est_error, cis, prop_rope) %>%
  rename('Estimate \u00B1 Est.Error' = est_error, '95% CIs' = cis, 'Inside ROPE' = prop_rope)

table2 <- cbind(waal_incub.fixef_MS, waal_brooding.fixef_MS)

## Reorder and rename rows
new_order <- c("Intercept",
               "colonycrozet", 
               "debt.days", 
               "median_trip.days", 
               "diff_trip.days", 
               "diff_var.days", 
               "debt.days:colonycrozet", 
               "colonycrozet:median_trip.days", 
               "colonycrozet:diff_trip.days", 
               "colonycrozet:diff_var.days", 
               "col.b_debt.days", 
               "col.b_median_trip.days", 
               "col.b_diff_trip.days", 
               "col.b_diff_var.days")

table2 <- table2[new_order, ]

# Rename rownames
new_names <- c(
  "Intercept",
  "Colony",
  "Fasting debt",
  "Pair-level median trip duration",
  "within-pair difference in trip duration",
  "within-pair difference in trip variability",
  "Fasting debt : Colony",
  "Pair-level median trip duration : Colony",
  "within-pair difference in trip duration : Colony",
  "within-pair difference in trip variability : Colony",
  "Fasting debt (crozet)",
  "Pair-level median trip duration (crozet)",
  "within-pair difference in trip duration (crozet)",
  "within-pair difference in trip variability (crozet)"
)

rownames(table2) <- new_names

## Get seasonal effects
waal_incub.season.row <- summary(waal_incub.brms)$random$season %>%
  as.data.frame() %>%
  mutate(`Estimate ± Est.Error` = paste0(round(Estimate, 2), " \u00B1 ", round(Est.Error, 2)),
         `95% CIs` = paste0("[", round(`l-95% CI`, 2), ", ", round(`u-95% CI`, 2), "]"),
          `Inside ROPE` = "") %>%
  select(`Estimate ± Est.Error`, `95% CIs`, `Inside ROPE`)

waal_brooding.season.row <- summary(waal_brooding.brms)$random$season %>%
  as.data.frame() %>%
  mutate(`Estimate ± Est.Error` = paste0(round(Estimate, 2), " \u00B1 ", round(Est.Error, 2)),
         `95% CIs` = paste0("[", round(`l-95% CI`, 2), ", ", round(`u-95% CI`, 2), "]"),
          `Inside ROPE` = "") %>%
  select(`Estimate ± Est.Error`, `95% CIs`, `Inside ROPE`)

waal_season <- cbind(waal_incub.season.row, waal_brooding.season.row)
rownames(waal_season) <- "(1|season)"
colnames(waal_season) <- colnames(table1)
table2 <- rbind(table2, waal_season)


table2 %>%
  kable("html", row.names = TRUE,
        caption = "Table 2. Parameter estimates from Bayesian binomial regression models examining the influence of behavioural parameters on breeding success in wandering albatrosses during incubation and brooding periods. Estimates are reported as log odds ‘Inside ROPE’ gives the proportion of posterior samples falling within the Region of Practical Equivalence (ROPE), a range at which effects are considered minimal. Estimates where >95% of posterior samples fell outside the ROPE are highlighted in bold. ‘Bird Island’ is the reference value for the categorical predictor ‘colony’; estimates for Kerguelen have been calculated by adding the interaction term to the main effect.") %>%
  row_spec(0, bold = TRUE) %>% 
  kable_classic() 

#readr::write_excel_csv(table2, "Data_outputs/table2_waal_coefficients.csv")

```

#### Calculate and plot conditional effects

```{r calculate_conditional_effects, eval = run_full_analysis}

effects <- 6:9

# BBAL -----
## INCUBATION -----

for (i in 1:length(effects)) {
  
  cond_term <- conditional_effects(bbal_incub.brms)[effects[i]]
  var_name <- names(cond_term)[1]
  var_name.data <- gsub(":colony|colony:", "", var_name) 
  var_label <- variable_labels[var_name]
  cond_term.df <- as.data.frame(cond_term[[1]])
 
  cond_plot <- ggplot() +
    geom_ribbon(aes(x = effect1__, ymin = lower__, ymax = upper__, fill = colony), 
                data = cond_term.df, alpha = 0.5) +
    geom_line(aes(x = effect1__, y = estimate__, col = colony), data = cond_term.df, linewidth = 1) +
    geom_point(aes(x = !!sym(var_name.data), y = breeding_outcome.bin, col = colony), data = bbal_incub.behaviour) +
    scale_fill_manual(values = c(bi_col, ker_col)) +
    scale_colour_manual(values = c(bi_col, ker_col)) +
    labs(x = var_label, y = expression("P|Breeding success"~(italic(P[i])))) +
    theme_bw() +
    theme(text = element_text(size = 16, family = "Calibri"),
          legend.position = "none")
  
  assign(paste0("bbal_incub.cond_plot.", var_name.data), cond_plot)
  
}


## BROODING ------

for (i in 1:length(effects)) {
  
  cond_term <- conditional_effects(bbal_brooding.brms)[effects[i]]
  var_name <- names(cond_term)[1]
  var_name.data <- gsub(":colony|colony:", "", var_name) 
  var_label <- variable_labels[var_name]
  cond_term.df <- as.data.frame(cond_term[[1]])
  
  cond_plot <- ggplot() +
    geom_ribbon(aes(x = effect1__, ymin = lower__, ymax = upper__, fill = colony), 
                data = cond_term.df, alpha = 0.5) +
    geom_line(aes(x = effect1__, y = estimate__, col = colony), data = cond_term.df, linewidth = 1) +
    geom_point(aes(x = !!sym(var_name.data), y = breeding_outcome.bin, col = colony), data = bbal_brooding.behaviour) +
    scale_fill_manual(values = c(bi_col, ker_col)) +
    scale_colour_manual(values = c(bi_col, ker_col)) +
    labs(x = var_label, y = expression("P|Breeding success"~(italic(P[i])))) +
    theme_bw() +
    theme(text = element_text(size = 16, family = "Calibri"),
          legend.position = "none")
  
  assign(paste0("bbal_brooding.cond_plot.", var_name.data), cond_plot)
  
}



# WAAL -------
## INCUBATION ------

for (i in 1:length(effects)) {
  
  cond_term <- conditional_effects(waal_incub.brms)[effects[i]]
  var_name <- names(cond_term)[1]
  var_name.data <- gsub(":colony|colony:", "", var_name) 
  var_label <- variable_labels[var_name]
  cond_term.df <- as.data.frame(cond_term[[1]])
  
  cond_plot <- ggplot() +
    geom_ribbon(aes(x = effect1__, ymin = lower__, ymax = upper__, fill = colony), 
                data = cond_term.df, alpha = 0.5) +
    geom_line(aes(x = effect1__, y = estimate__, col = colony), data = cond_term.df, linewidth = 1) +
    geom_point(aes(x = !!sym(var_name.data), y = breeding_outcome.bin, col = colony), data = waal_incub.behaviour) +
    scale_fill_manual(values = c(bi_col, ker_col)) +
    scale_colour_manual(values = c(bi_col, ker_col)) +
    labs(x = var_label, expression("P|Breeding success"~(italic(P[i])))) +
    theme_bw() +
    theme(text = element_text(size = 16, family = "Calibri"),
          legend.position = "none")
  
  assign(paste0("waal_incub.cond_plot.", var_name.data), cond_plot)
  
}


## BROODING -------

for (i in 1:length(effects)) {
  
  cond_term <- conditional_effects(waal_brooding.brms)[effects[i]]
  var_name <- names(cond_term)[1]
  var_name.data <- gsub(":colony|colony:", "", var_name) 
  var_label <- variable_labels[var_name]
  cond_term.df <- as.data.frame(cond_term[[1]])
  
  cond_plot <- ggplot() +
    geom_ribbon(aes(x = effect1__, ymin = lower__, ymax = upper__, fill = colony), 
                data = cond_term.df, alpha = 0.5) +
    geom_line(aes(x = effect1__, y = estimate__, col = colony), data = cond_term.df, linewidth = 1) +
    geom_point(aes(x = !!sym(var_name.data), y = breeding_outcome.bin, col = colony), data = waal_brooding.behaviour) +
    scale_fill_manual(values = c(bi_col, ker_col)) +
    scale_colour_manual(values = c(bi_col, ker_col)) +
    labs(x = var_label, y = expression("P|Breeding success"~(italic(P[i])))) +
    theme_bw() +
    theme(text = element_text(size = 16, family = "Calibri"),
          legend.position = "none")
  
  assign(paste0("waal_brooding.cond_plot.", var_name.data), cond_plot)
 
}

# Save plots that are used in MS
save(bbal_incub.cond_plot.median_trip.days, file = "Data_outputs/bbal_incub.cond_plot.median_trip.days.RData")
save(bbal_brooding.cond_plot.median_trip.days, file = "Data_outputs/bbal_brooding.cond_plot.median_trip.days.RData")
save(bbal_brooding.cond_plot.diff_trip.days,file = "Data_outputs/bbal_brooding.cond_plot.diff_trip.days.RData")
save(waal_incub.cond_plot.diff_var.days,file = "Data_outputs/waal_incub.cond_plot.diff_var.days.RData")
save(waal_brooding.cond_plot.median_trip.days,file = "Data_outputs/waal_brooding.cond_plot.median_trip.days.RData")
save(waal_brooding.cond_plot.diff_trip.days,file = "Data_outputs/waal_brooding.cond_plot.diff_trip.days.RData")

```

```{r Figure2_bbal_condiitonal_effects, fig.width = 10, fig.height = 10, fig.cap = "**Figure 2.** Conditional effect estimates of (A) pair-level median trip duration during incubation, and (B) pair-level median trip duration and (C) within-pair difference in trip duration during brooding on breeding success of black-browed albatrosses. Effects are shown separately for Bird Island (orange) and Kerguelen (blue). Solid lines represent the estimated mean effect, and the shaded areas denote the 95% credible interval. Data points correspond to individual pair estimates. Note that some estimates may extend outside the range of observed data due to extrapolation and should thus be interpreted with caution."}

load("Data_outputs/bbal_incub.cond_plot.median_trip.days.RData")
load("Data_outputs/bbal_brooding.cond_plot.median_trip.days.RData")
load("Data_outputs/bbal_brooding.cond_plot.diff_trip.days.RData")

bbal_incub.cond_plot.median_trip.days2 <- ggdraw() +
  draw_plot(bbal_incub.cond_plot.median_trip.days + labs(tag = "A",
                                                        y = "Incubation \nP|Breeding success") +
              theme(axis.title.y = element_text(margin = margin(r = 35)),
                    plot.tag = element_text(size = 16, face = "bold"),
                    plot.tag.position = c(0.05, 1.01),
                    plot.margin = unit(c(0.6, 0.2, 0.1, 0.5), "cm"),
                    text = element_text(size = 16, family = "Calibri"))) +
  draw_image(file.path("Figures/bbal_standing_silhouette.png"),
             scale = 0.25, x = 0.32, y = -0.23) 

#png(file = "Figures/FIGURE2.png", width = 10, height = 10, units = "in", res = 300)
ggarrange(
  bbal_incub.cond_plot.median_trip.days2,
  NULL,
  bbal_brooding.cond_plot.median_trip.days + 
    labs(tag = "B", y = "Brooding \nP|Breeding success") + 
    xlim(0.5, 5.8) +
    theme(plot.tag = element_text(size = 16, face = "bold"),
          axis.title.y = element_text(margin = margin(r = 35)),
          plot.tag.position = c(0.05, 1.01),
          plot.margin = unit(c(0.6, 0.2, 0.1, 0.5), "cm")),
  bbal_brooding.cond_plot.diff_trip.days + 
    labs(tag = "C") +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank(),
          plot.tag = element_text(size = 16, face = "bold"),
          plot.margin = unit(c(0.3, 0.2, 0.1, 0.5), "cm")),
  ncol = 2,
  nrow = 2,
  widths = c(1, 0.85)
)
#dev.off()

```

```{r Figure3_waal_condiitonal_effects, fig.width = 10, fig.height = 10, fig.cap = "**Figure 3.** Conditional effect estimates of (A) within-pair difference in trip variability during incubation, and (B) pair-level median trip duration and (C) within-pair difference in trip duration during brooding on breeding success of wandering albatrosses. Effects are shown separately for Bird Island (orange) and Crozet (blue). Solid lines represent the estimated mean effect, and the shaded areas denote the 95% credible interval. Data points correspond to individual pair estimates."}

load("Data_outputs/waal_incub.cond_plot.diff_var.days.RData")
load("Data_outputs/waal_brooding.cond_plot.median_trip.days.RData")
load("Data_outputs/waal_brooding.cond_plot.diff_trip.days.RData")

# Add albatross silhouette
waal_incub.cond_plot.diff_var.days2 <- ggdraw() +
  draw_plot(waal_incub.cond_plot.diff_var.days +
              labs(tag = "A", y = "Incubation \nP|Breeding success") +
              theme(axis.title.y = element_text(margin = margin(r = 35)),
                    plot.tag = element_text(size = 16, face = "bold"),
                    plot.tag.position = c(0.05, 1),
                    plot.margin = unit(c(0.6, 0.2, 0.1, 0.5), "cm"),
                    text = element_text(size = 16, family = "Calibri"))) +
  draw_image(file.path("Figures/waal_standing_silhouette.png"),
             scale = 0.3, x = -0.12, y = -0.18)

#png(file = "Figures/FIGURE3.png", width = 10, height = 10, units = "in", res = 300)
ggarrange(
  waal_incub.cond_plot.diff_var.days2,
  NULL,
  waal_brooding.cond_plot.median_trip.days + 
    labs(tag = "B", y = "Brooding \nP|Breeding success") + 
    theme(plot.tag = element_text(size = 16, face = "bold"),
          axis.title.y = element_text(margin = margin(r = 35)),
           plot.tag.position = c(0.05, 1),
          plot.margin = unit(c(0.6, 0.2, 0.1, 0.5), "cm")),
  waal_brooding.cond_plot.diff_trip.days + 
    labs(tag = "C") +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank(),
          plot.tag = element_text(size = 16, face = "bold"),
          plot.margin = unit(c(0.3, 0.2, 0.1, 0.5), "cm")),
  ncol = 2,
  nrow = 2,
  widths = c(1, 0.85)
)
#dev.off()

```

## Reporting the results

*Here I report the estimates and CIs, with an accompanying estimated change in probability to aid interpretation.*

```{r calc_estimates_to_report}

# seasonal effects
bbal_incub_season.SD <- table1$`Estimate ± Est.Error`[15]
bbal_brooding_season.SD <- table1[15, 4]

waal_incub_season.SD <- table2$`Estimate ± Est.Error`[15]
waal_brooding_season.SD <- table2[15, 4]


# bbal_incub_ker.T
bbal_incub_ker.T_coef <- bbal_incub.fixef$Estimate[12]
bbal_incub_ker.T_CI <- paste0("[", bbal_incub.fixef$`l-95% CI`[12], "-", bbal_incub.fixef$`u-95% CI`[12], "]")

bbal_incub_ker.T_probs <- calculate_prob_change(bbal_incub.brms, bbal_incub.behaviour, "median_trip.days", c(2,7), "kerguelen")

bbal_incub_ker.T_probChg <- as.numeric(bbal_incub_ker.T_probs$prob_change)
bbal_incub_ker.T_probCIChg <- bbal_incub_ker.T_probs$ci_change

# bbal_incub_bi.T
bbal_incub_bi.T_coef <- bbal_incub.fixef$Estimate[4]
bbal_incub_bi.T_CI <- paste0("[", bbal_incub.fixef$`l-95% CI`[4], "-", bbal_incub.fixef$`u-95% CI`[4], "]")

bbal_incub_bi.T_probs <- calculate_prob_change(bbal_incub.brms, bbal_incub.behaviour, "median_trip.days", c(2,7), "birdisland")

bbal_incub_bi.T_probChg <- as.numeric(bbal_incub_bi.T_probs$prob_change)
bbal_incub_bi.T_probCIChg <- bbal_incub_bi.T_probs$ci_change


# bbal_brooding_ker.T
bbal_brooding_ker.T_coef <- bbal_brooding.fixef$Estimate[12]
bbal_brooding_ker.T_CI <- paste0("[", bbal_brooding.fixef$`l-95% CI`[12], "-", bbal_brooding.fixef$`u-95% CI`[12], "]")

bbal_brooding_ker.T_probs <- calculate_prob_change(bbal_brooding.brms, bbal_brooding.behaviour, "median_trip.days", c(2,7), "kerguelen")

bbal_brooding_ker.T_probChg <- as.numeric(bbal_brooding_ker.T_probs$prob_change)
bbal_brooding_ker.T_probCIChg <- bbal_brooding_ker.T_probs$ci_change

# bbal_brooding_ker.D
bbal_brooding_ker.D_coef <- bbal_brooding.fixef$Estimate[13]
bbal_brooding_ker.D_CI <- paste0("[", bbal_brooding.fixef$`l-95% CI`[13], "-", bbal_brooding.fixef$`u-95% CI`[13], "]")

bbal_brooding_ker.D_probs <- calculate_prob_change(bbal_brooding.brms, bbal_brooding.behaviour, "diff_trip.days", c(2,7), "kerguelen")

bbal_brooding_ker.D_probChg <- as.numeric(bbal_brooding_ker.D_probs$prob_change)
bbal_brooding_ker.D_probCIChg <- bbal_brooding_ker.D_probs$ci_change


# waal_incub_cro_V
waal_incub_cro.V_coef <- waal_incub.fixef$Estimate[14]
waal_incub_cro.V_CI <- paste0("[", waal_incub.fixef$`l-95% CI`[14], "-", waal_incub.fixef$`u-95% CI`[14], "]")

waal_incub_cro.V_probs <- calculate_prob_change(waal_incub.brms, waal_brooding.behaviour, "diff_var.days", c(2,7), "crozet")

waal_incub_cro.V_probChg <- as.numeric(waal_incub_cro.V_probs$prob_change)
waal_incub_cro.V_probCIChg <- waal_incub_cro.V_probs$ci_change


# waal_brooding_cro_T
waal_brooding_cro.T_coef <- waal_brooding.fixef$Estimate[12]
waal_brooding_cro.T_CI <- paste0("[", waal_brooding.fixef$`l-95% CI`[12], "-", waal_brooding.fixef$`u-95% CI`[12], "]")

waal_brooding_cro.T_probs <- calculate_prob_change(waal_brooding.brms, waal_brooding.behaviour, "median_trip.days", c(2,7), "crozet")

waal_brooding_cro.T_probChg <- as.numeric(waal_brooding_cro.T_probs$prob_change)
waal_brooding_cro.T_probCIChg <- waal_brooding_cro.T_probs$ci_change

# waal_brooding_cro_D
waal_brooding_cro.D_coef <- waal_brooding.fixef$Estimate[13]
waal_brooding_cro.D_CI <- paste0("[", waal_brooding.fixef$`l-95% CI`[13], "-", waal_brooding.fixef$`u-95% CI`[13], "]")

waal_brooding_cro.D_probs <- calculate_prob_change(waal_brooding.brms, waal_brooding.behaviour, "diff_trip.days", c(2,7), "crozet")

waal_brooding_cro.D_probChg <- as.numeric(waal_brooding_cro.D_probs$prob_change)
waal_brooding_cro.D_probCIChg <- waal_brooding_cro.D_probs$ci_change

```


Our analyses provided evidence that both the overall level of parental investment and the degree of coordination between the partners influenced breeding success in both black-browed and wandering albatrosses, with several effects showing similar patterns across species at the same (or nearby, in the case of Possession Island and Kerguelen) islands (Figure 1). However, the magnitude of these effects was somewhat smaller in wandering albatrosses, and effects were more pronounced during brooding than during incubation in both species. We found consistent among-season variation in breeding success across all models (Table 1, Table 2). Seasonal variability was greater during brooding (SD = `r bbal_brooding_season.SD` for black-browed albatrosses; `r waal_brooding_season.SD` for wandering albatrosses) than incubation (SD = `r bbal_incub_season.SD` and `r waal_incub_season.SD` respectively), suggesting stronger annual effects later in the breeding season.

During incubation, breeding success in black-browed albatrosses increased with pair-level median trip duration ($T$) at both Bird Island and Kerguelen (Table 1). The estimated effects (log-odds, with 95% credible intervals) were `r bbal_incub_bi.T_coef` `r bbal_incub_bi.T_CI` at Bird Island and `r bbal_incub_ker.T_coef` `r bbal_incub_ker.T_CI` at Kerguelen. Over a 5-day increase in trip duration, this corresponded to an approximate increase in breeding success of `r bbal_incub_bi.T_probChg` `r bbal_incub_bi.T_probCIChg` percentage points at Bird Island, and a `r bbal_incub_ker.T_probChg` `r bbal_incub_ker.T_probCIChg` at Kerguelen (Figure 2A). We found no evidence that the fasting debt ($F$), difference in trip duration ($D$), or difference in trip variability ($V$) affected breeding success during incubation.

During brooding, breeding success at Kerguelen, but not at Bird Island, was positively associated with pair-level median trip duration ($T$; estimate = `r bbal_brooding_ker.T_coef` `r bbal_brooding_ker.T_CI`; Table 1), with a 5-day increase in trip duration corresponding to an approximate gain of `r bbal_brooding_ker.T_probChg` `r bbal_brooding_ker.T_probCIChg` percentage points (Figure 2B). However, the very wide credible interval, spanning both small positive and large positive values, reflects considerable uncertainty due to the small number of observations at Kerguelen, particularly for breeding failure. In contrast, greater within-pair difference in trip duration ($D$) reduced breeding success (`r bbal_brooding_ker.D_coef` `r bbal_brooding_ker.D_CI`; Table 1), corresponding to a `r bbal_brooding_ker.D_probChg` `r bbal_brooding_ker.D_probCIChg` percentage point decrease over a 5-day increase in duration differences. While both effects suggest a potential relationship, the credible intervals for both effects include 1 and span a very wide range of values, and just thus be interpreted with caution. We found no evidence for effects of behaviour at Bird Island, and no effects of $F$ or $V$ at Kerguelen. 

In wandering albatrosses, we detected negligible evidence for effects of the various pair-level foraging metrics during incubation or brooding at Bird Island (Table 2). At Crozet, however, greater within-pair difference in trip variability ($V$) during incubation were weakly associated with lower breeding success (estimate = `r waal_incub_cro.V_coef` `r waal_incub_cro.V_CI`; Table 2), corresponding to an approximate decline in breeding success of `r waal_incub_cro.V_probChg` `r waal_incub_cro.V_probCIChg` percentage points over a 5-day increase in trip variability difference.

During brooding at Crozet, breeding success increased with pair-level median trip duration ($T$; estimate = `r waal_brooding_cro.T_coef` `r waal_brooding_cro.T_CI`; Table 2), with a 5-day increase in trip duration leading to a decline of `r waal_brooding_cro.T_probChg` `r waal_brooding_cro.T_probCIChg` percentage points in breeding success. Conversely, greater within-pair difference in trip duration ($D$) reduced breeding success (estimate = `r waal_brooding_cro.D_coef` `r waal_brooding_cro.D_CI`; Table 2), resulting in a decline in breeding success of `r waal_brooding_cro.D_probChg` `r waal_brooding_cro.D_probCIChg` percentage points over a 5-day increase in duration differences, though note again the uncertainty in these estimates. 


```{r behavioural_correlations, eval = FALSE}

# BBA #
# Incubation
behav_cor_bbal.incub <- ggpairs(
  data = bbal_incub.behaviour %>%
    select(colony, debt.days, median_trip.days, diff_trip.days, diff_var.days),
  columns = 2:5,
  mapping = ggplot2::aes(colour = colony),
  title = "Behavioural correlations by colony") +
  scale_colour_manual(values = c(bi_col, ker_col)) +
  scale_fill_manual(values = c(bi_col, ker_col))

# Brooding
behav_cor_bbal.brooding <- ggpairs(
  data = bbal_brooding.behaviour %>%
    select(colony, debt.days, median_trip.days, diff_trip.days, diff_var.days),
  columns = 2:5,
  mapping = ggplot2::aes(colour = colony),
  title = "Behavioural correlations by colony") +
  scale_colour_manual(values = c(bi_col, ker_col)) +
  scale_fill_manual(values = c(bi_col, ker_col))

# WAAL #
# Incubation
behav_cor_waal_incub <- ggpairs(
  data = waal_incub.behaviour %>%
    select(colony, debt.days, median_trip.days, diff_trip.days, diff_var.days),
  columns = 2:5,
  mapping = ggplot2::aes(colour = colony),
  title = "Behavioural correlations by colony") +
  scale_colour_manual(values = c(bi_col, ker_col)) +
  scale_fill_manual(values = c(bi_col, ker_col))

# Brooding
behav_cor_waal.brooding <- ggpairs(
  data = waal_brooding.behaviour %>%
    select(colony, debt.days, median_trip.days, diff_trip.days, diff_var.days),
  columns = 2:5,
  mapping = ggplot2::aes(colour = colony),
  title = "Behavioural correlations by colony") +
  scale_colour_manual(values = c(bi_col, ker_col)) +
  scale_fill_manual(values = c(bi_col, ker_col))


```
